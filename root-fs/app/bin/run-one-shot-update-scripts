#!/bin/bash

set -o errexit
set -o nounset
set -o pipefail

type=$1
scriptDir=/app/bin/$type.d
logDir=/data/bluespice/logs/$type
timestamp=$(date +%Y%m%d%H%M%S)

echo "Running $type scripts"

for f in "$scriptDir"/*; do
	scriptName=$(basename $f)
	logFile=/data/bluespice/logs/$type/$scriptName.log
	errorLogFile=/data/bluespice/logs/$type/$scriptName.$timestamp.error.log
	if [ -f "$logFile" ]; then
		continue
	fi

	if [ -f "$f" ]; then
		echo ""
		echo "$f"
		$f \
			| tee -a $logFile
		if [ $? -ne 0 ]; then
			echo "Error running $f"
			mv $logFile $errorLogFile
			exit 1
		fi
	fi
done
