#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

substitutePlaceholders /app/conf/nginx_bluespice
if [[ -n "${WIKI_BASE_PATH}" && "${WIKI_BASE_PATH}" != "/" ]]; then
	mkdir -p /app/bluespice${WIKI_BASE_PATH}
	ln -sf /app/bluespice/w /app/bluespice${WIKI_BASE_PATH}w
fi

echo ""
echo "#############################################"
echo "🌐 Starting WebFrontend"

# During initial setup, the web container may be started _before_ the task container had th chance to create
# the /data/.wikienv file. In this case, we wait until it is created.
while [ ! -f /data/.wikienv ]; do
	echo "Waiting for /data/.wikienv to be created..."
	sleep 1
done
set -a
source /data/.wikienv
set +a

echo "" > /tmp/healthcheck
echo "php-fpm" >> /tmp/healthcheck # Process name is `php-fpm`, not `php-fpm8.4`
echo "nginx" >> /tmp/healthcheck

php-fpm -D && nginx -g "daemon off;"
