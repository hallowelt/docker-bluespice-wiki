#!/bin/bash

cat <<EOF
  ____  _            ____        _
 | __ )| |_   _  ___/ ___| _ __ (_) ___ ___
 |  _ \| | | | |/ _ \___ \| '_ \| |/ __/ _ \\
 | |_) | | |_| |  __/___) | |_) | | (_|  __/
 |____/|_|\__,_|\___|____/| .__/|_|\___\___|
                          |_|
EOF
blueSpiceVersion=$(cat /app/bluespice/w/BLUESPICE-VERSION)
blueSpiceEdition=$(cat /app/bluespice/w/BLUESPICE-EDITION)
blueSpiceBuildInfo=$(cat /app/bluespice/w/BUILDINFO)
echo "ðŸš€ BlueSpice $blueSpiceEdition $blueSpiceVersion+$blueSpiceBuildInfo"
echo "---------------------------------------------"
echo ""

if [ -z "$WIKI_PROXY" ]; then
  export WIKI_PROXY=$(getent hosts proxy | awk '{ print $1 ; exit }')
fi

export PATH=$PATH:/app/bin
substitutePlaceholders /app/bin/config/clamd.conf

if [ -f /data/.wikienv ]; then
  # For b/c, in case 5.2 bluespice/helper was not used and file was not migrated therefore
  set -a
  source /data/.wikienv
  set +a
fi

# Since 5.2
# Load secrets; Omit subdirectories and non-uppercase filenames
for secret in $(find /run/secrets/ -maxdepth 1 -type f | grep -E '/[A-Z_]+$' | xargs -n1 basename); do
  # For grep:
  # - INTERNAL_CHAT_TOKEN
  # - INTERNAL_SIMPLESAMLPHP_ADMIN_PASS
  # - INTERNAL_SIMPLESAMLPHP_SECRET_SALT
  # - INTERNAL_WIKI_SECRETKEY
  # - INTERNAL_WIKI_UPGRADEKEY
  # - INTERNAL_WIKI_TOKEN_AUTH_SALT
  # - INTERNAL_WIRE_API_KEY
  echo "$secret=$(cat /run/secrets/$secret)" >> /data/.env
done

if [ -f /data/.env ]; then
  # For grep:
    # - EDITION
  set -a
  source /data/.env
  set +a
fi

exec sh -c "$@"